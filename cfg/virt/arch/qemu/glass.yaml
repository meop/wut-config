---
environment:
  - QEMU_GUEST_NAME=glass
  - QEMU_GUEST_SYS_ARCH=x86_64
  - QEMU_GUEST_SYS_PLAT=winnt
  ## bridge
  - QEMU_HOST_NIC=br0
  - QEMU_HOST_NIC_MAC=52:54:00:67:6C:61
  ## macvtap
  # - QEMU_HOST_NIC=mvt0
  - VFIO_PCI_DEV_IDS=01:00.0,01:00.1,01:00.2,01:00.3
swtpm:
  arguments:
    - socket
    - --ctrl type=unixio,path={TMP_QEMU_DIR_PATH}/{QEMU_GUEST_NAME}/tpm.socket
    - --log file=-
    - --tpm2
    - --tpmstate dir={TMP_QEMU_DIR_PATH}/{QEMU_GUEST_NAME}
    - --daemon
qemu:
  arguments:
    - -name {QEMU_GUEST_NAME},debug-threads=on
    - -machine type=q35,accel=kvm,pflash0=flash0,pflash1=flash1
    - -nodefaults
    - -global ICH9-LPC.disable_s3=1
    - -global ICH9-LPC.disable_s4=1
    - -global driver=cfi.pflash01,property=secure,value=on
    - -blockdev driver=file,node-name=flash0,read-only=on,filename={VIRT_QEMU_DIR_PATH}/{QEMU_GUEST_NAME}/OVMF_CODE_4M.ms.fd
    - -blockdev driver=file,node-name=flash1,discard=unmap,filename={VIRT_QEMU_DIR_PATH}/{QEMU_GUEST_NAME}/OVMF_VARS_4M.ms.fd
    - -boot menu=on
    - -chardev socket,id=cdtpm0,path={TMP_QEMU_DIR_PATH}/{QEMU_GUEST_NAME}/tpm.socket
    - -tpmdev emulator,id=tpm0,chardev=cdtpm0
    - -device tpm-tis,tpmdev=tpm0
    - -rtc base=localtime,clock=host
    - -cpu host,host-cache-info=on,migratable=off{QEMU_GUEST_CPU_FLAGS}
    - -smp sockets={QEMU_GUEST_CPU_SOCKETS},cores={QEMU_GUEST_CPU_CORES},threads={QEMU_GUEST_CPU_THREADS}
    - -m 24g
    ## bridge
    - -netdev bridge,id=net0,br={QEMU_HOST_NIC}
    ## macvlan
    # - -netdev tap,id=net0,fd=3,vhost=on,vhostfd=4 3<> /dev/tap{QEMU_HOST_NIC_IF_INDEX} 4<> /dev/vhost-net
    - -device virtio-net-pci,netdev=net0,mac={QEMU_HOST_NIC_MAC}
    - -device virtio-rng-pci
    - -device qemu-xhci
    - -drive "if=none,media=cdrom,id=iso0,readonly=on,file={DATA_WARE_IMAGES_DIR_PATH}/{QEMU_GUEST_SYS_PLAT}/Win11_24H2_English_x64.iso"
    - -device usb-storage,drive=iso0,removable=true
    - -drive "if=none,media=cdrom,id=iso1,readonly=on,file={DATA_WARE_IMAGES_DIR_PATH}/{QEMU_GUEST_SYS_PLAT}/virtio-win-0.1.271.iso"
    - -device usb-storage,drive=iso1,removable=true
    - -object iothread,id=iot0
    - -object iothread,id=iot1
    # - -object iothread,id=iot2
    # - -object iothread,id=iot3
    ## os disk
    - -device virtio-scsi-pci,id=scsi0,iothread=iot0
    # - -device '{"driver":"virtio-scsi-pci","id":"scsi0","iothread-vq-mapping":[{"iothread":"iot0"},{"iothread":"iot1"}]}'
    - -blockdev driver=file,node-name=file0,aio=native,cache.direct=on,discard=unmap,filename={VIRT_QEMU_DIR_PATH}/{QEMU_GUEST_NAME}/os.raw
    - -blockdev driver=raw,node-name=ssd0,file=file0
    - -device scsi-hd,bus=scsi0.0,scsi-id=0,drive=ssd0,rotation_rate=1
    ## data disk
    - -device virtio-scsi-pci,id=scsi1,iothread=iot1
    # - -device '{"driver":"virtio-scsi-pci","id":"scsi1","iothread-vq-mapping":[{"iothread":"iot2"},{"iothread":"iot3"}]}'
    - -blockdev driver=host_device,node-name=file1,aio=native,cache.direct=on,discard=unmap,filename=/dev/disk/by-id/ata-CT2000MX500SSD1_1905E1E7E300
    - -blockdev driver=raw,node-name=ssd1,file=file1
    - -device scsi-hd,bus=scsi1.0,scsi-id=0,drive=ssd1,rotation_rate=1
    ## devices emulated (no drivers needed, for installing os)
    # - -device usb-kbd
    # - -device usb-tablet
    # - -device ramfb
    ## devices virtio (drivers needed, for running os)
    # - -device virtio-keyboard-pci
    # - -device virtio-tablet-pci
    # - -device virtio-gpu-pci
    ## gpu virtual
    # - -display gtk
    # - -monitor stdio
    ## gpu passthru
    - -display none
    - -device vfio-pci,host={VFIO_PCI_DEV_IDS_0},multifunction=on
    - -device vfio-pci,host={VFIO_PCI_DEV_IDS_1}
    - -device vfio-pci,host={VFIO_PCI_DEV_IDS_2}
    - -device vfio-pci,host={VFIO_PCI_DEV_IDS_3}
    - -monitor unix:{TMP_QEMU_DIR_PATH}/{QEMU_GUEST_NAME}/monitor.socket,server=on,wait=off
    - -qmp unix:{TMP_QEMU_DIR_PATH}/{QEMU_GUEST_NAME}/qmp.socket,server=on,wait=off
    - -daemonize
